/**
 * SunGuide 15-min rollup query (PARAMETERIZED)
 * IMPORTANT:
 *  - DO NOT declare @StartDate or @EndDate in this SQL.
 *  - server.js passes them using .input("StartDate", ...) etc.
 */
function buildRollupQuerySql() {
  return `
SET NOCOUNT ON;
SET IMPLICIT_TRANSACTIONS OFF;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

------------------------------------------------------------
-- 0) Lane mapping table
------------------------------------------------------------
DECLARE @LaneSegmentMap TABLE (
    LANE_NAME varchar(200) NOT NULL,
    SID       varchar(200) NULL,
    SEGMENTS  varchar(200) NULL
);

INSERT INTO @LaneSegmentMap (LANE_NAME, SID, SEGMENTS) VALUES
('11GP-SR023-020_7','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-020_7','FT_S_285.721_290.721','RR 14'),
('13AX-SR023-020_7','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-021_3','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-021_3-A','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-021_3','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-021_3-A','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-021_8','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-021_8','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-022_3','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-022_3','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-022_8','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-022_8','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-023_3','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-023_3','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-023_8','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-023_8','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-024_2','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-024_2','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-024_8','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-024_8','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-025_3','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-025_3','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-025_8','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-025_8','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-026_3','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-026_3','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-026_8','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-026_8','FT_S_285.721_290.721','RR 14'),
('11GP-SR023-027_3','FT_S_285.721_290.721','RR 14'),
('12GP-SR023-027_3','FT_S_285.721_290.721','RR 14'),
('01GP-SR023-036_6','FC_P_36.648_38.648','RR 3'),
('01GP-SR023-036_6-A','FC_P_36.648_38.648','RR 3'),
('023-036_6-NB-A-LNK-lane1','FC_P_36.648_38.648','RR 3'),
('02GP-SR023-036_6','FC_P_36.648_38.648','RR 3'),
('02GP-SR023-036_6-A','FC_P_36.648_38.648','RR 3'),
('01GP-SR023-037_1','FC_P_36.648_38.648','RR 3'),
('01GP-SR023-037_1-A','FC_P_36.648_38.648','RR 3'),
('02GP-SR023-037_1','FC_P_36.648_38.648','RR 3'),
('02GP-SR023-037_1-A','FC_P_36.648_38.648','RR 3'),
('01AX-SR023-037_6','FC_P_36.648_38.648','RR 3'),
('01GP-SR023-037_6','FC_P_36.648_38.648','RR 3'),
('02GP-SR023-037_6','FC_P_36.648_38.648','RR 3'),
('03AX-SR023-037_6','FC_P_36.648_38.648','RR 3'),
('03GP-SR023-037_6','FC_P_36.648_38.648','RR 3'),
('01GP-SR023-0038_1','FC_P_36.648_38.648','RR 3'),
('01GP-SR023-0038_1-A','FC_P_36.648_38.648','RR 3'),
('01GP-SR023-038_1-A','FC_P_36.648_38.648','RR 3'),
('02GP-SR023-038_1','FC_P_36.648_38.648','RR 3'),
('02GP-SR023-038_1-A','FC_P_36.648_38.648','RR 3'),
('01GP-SR023-038_6','FC_P_36.648_38.648','RR 3'),
('01GP-SR023-038_6-A','FC_P_36.648_38.648','RR 3'),
('02GP-SR023-038_6','FC_P_36.648_38.648','RR 3'),
('02GP-SR023-038_6-A','FC_P_36.648_38.648','RR 3'),
('01GP-SR091-132_1','FT_P_132.165_134.165','RR 8'),
('02GP-SR091-132_1','FT_P_132.165_134.165','RR 8'),
('01GP-SR091-132_4','FT_P_132.165_134.165','RR 8'),
('02GP-SR091-132_4','FT_P_132.165_134.165','RR 8'),
('01GP-SR091-132-7','FT_P_132.165_134.165','RR 8'),
('01GP-SR091-132_7','FT_P_132.165_134.165','RR 8'),
('02GP-SR091-132-7','FT_P_132.165_134.165','RR 8'),
('02GP-SR091-132_7','FT_P_132.165_134.165','RR 8'),
('091-132-7NSB-LNK-lane1','FT_P_132.165_134.165','RR 8'),
('01GP-SR091-133_1','FT_P_132.165_134.165','RR 8'),
('02GP-SR091-133_1','FT_P_132.165_134.165','RR 8'),
('091133-2NB-LANE1','FT_P_132.165_134.165','RR 8'),
('091133-2NB-LANE2','FT_P_132.165_134.165','RR 8'),
('01GP-SR091-133_6','FT_P_132.165_134.165','RR 8'),
('01GP-SR091-133_7','FT_P_132.165_134.165','RR 8'),
('02GP-SR091-133_6','FT_P_132.165_134.165','RR 8'),
('02GP-SR091-133_7','FT_P_132.165_134.165','RR 8'),
('01GP-SR091-133_8','FT_P_132.165_134.165','RR 8'),
('02GP-SR091-133_8','FT_P_132.165_134.165','RR 8'),
('01GP-SR091-134_2','FT_P_132.165_134.165','RR 8'),
('02GP-SR091-134_2','FT_P_132.165_134.165','RR 8'),
('11GP-SR091-142_0','FT_S_141.737_143.737','RR 8'),
('12GP-SR091-142_0','FT_S_141.737_143.737','RR 8'),
('11GP-SR091-142_5','FT_S_141.737_143.737','RR 8'),
('12GP-SR091-142_5','FT_S_141.737_143.737','RR 8'),
('11GP-SR091-143_1','FT_S_141.737_143.737','RR 8'),
('12GP-SR091-143_1','FT_S_141.737_143.737','RR 8'),
('11GP-SR091-143_8','FT_S_143.737_145.737','RR 8'),
('12GP-SR091-143_8','FT_S_143.737_145.737','RR 8'),
('11GP-SR091-144_2','FT_S_143.737_145.737','RR 8'),
('12GP-SR091-144_2','FT_S_143.737_145.737','RR 8'),
('11GP-SR091-144_6','FT_S_143.737_145.737','RR 8'),
('12GP-SR091-144_6','FT_S_143.737_145.737','RR 8'),
('11GP-SR091-145_1','FT_S_143.737_145.737','RR 8'),
('12GP-SR091-145_1','FT_S_143.737_145.737','RR 8'),
('11GP-SR091-145_4','FT_S_143.737_145.737','RR 8'),
('12GP-SR091-145_4','FT_S_143.737_145.737','RR 8'),
('11GP-SR091-182_1','FT_S_182.11_187.11','RR 9'),
('12GP-SR091-182_1','FT_S_182.11_187.11','RR 9'),
('11GP-SR091-183_1','FT_S_182.11_187.11','RR 9'),
('12GP-SR091-183_1','FT_S_182.11_187.11','RR 9'),
('11GP-SR091-183_6','FT_S_182.11_187.11','RR 9'),
('12GP-SR091-183_6','FT_S_182.11_187.11','RR 9'),
('11GP-SR091-184_6','FT_S_182.11_187.11','RR 9'),
('12GP-SR091-184_6','FT_S_182.11_187.11','RR 9'),
('11GP-SR091-185_0','FT_S_182.11_187.11','RR 9'),
('12GP-SR091-185_0','FT_S_182.11_187.11','RR 9'),
('11GP-SR091-185_1','FT_S_182.11_187.11','RR 9'),
('12GP-SR091-185_11','FT_S_182.11_187.11','RR 9'),
('11GP-SR091-185_9','FT_S_182.11_187.11','RR 9'),
('12GP-SR091-185_9','FT_S_182.11_187.11','RR 9'),
('11GP-SR091-186_4','FT_S_182.11_187.11','RR 9'),
('12GP-SR091-186_4','FT_S_182.11_187.11','RR 9'),
('01GP-SR091-187_0','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-187_0','FT_P_187.0_192.0','RR 10'),
('11GP-SR091-187_0','FT_S_182.11_187.11','RR 9'),
('12GP-SR091-187_0','FT_S_182.11_187.11','RR 9'),
('01GP-SR091-187_4','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-187_4','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-187_9','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-187_9','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-188_4','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-188_5','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-188_4','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-188_5','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-188_9','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-188_9','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-189_5','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-189_5','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-189_0','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-189_9','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-189_0','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-189_9','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-190_4','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-190_4','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-190_9','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-190_9','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-191_4','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-191_4','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-191_9','FT_P_187.0_192.0','RR 10'),
('01GP-SR091-192_0','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-191_9','FT_P_187.0_192.0','RR 10'),
('02GP-SR091-192_0','FT_P_187.0_192.0','RR 10'),
('11GP-SR091-193_9','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-193_9','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-194_4','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-194_4','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-194_9','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-194_9','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-195_7','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-195_7','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-196_7','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-196_7','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-197_3','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-197_3','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-197_6','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-197_6','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-198_3','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-198_3','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-198_6','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-198_8','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-198_6','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-198_8','FT_S_193.736_198.736','RR 10'),
('11GP-SR091-198_9','FT_S_193.736_198.736','RR 10'),
('12GP-SR091-198_9','FT_S_193.736_198.736','RR 10'),
('01GP-SR091-223_9','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-223_9','FT_P_223.194_228.194','RR 10'),
('01GP-SR091-225_0','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-225_0','FT_P_223.194_228.194','RR 10'),
('11GP-SR091-225_0','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-225_0','FT_S_224.07_229.07','RR 10'),
('01GP-SR091-225_5','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-225_5','FT_P_223.194_228.194','RR 10'),
('11GP-SR091-225_5','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-225_5','FT_S_224.07_229.07','RR 10'),
('01GP-SR091-225_9','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-225_9','FT_P_223.194_228.194','RR 10'),
('11GP-SR091-225_9','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-225_9','FT_S_224.07_229.07','RR 10'),
('01GP-SR091-226_0','FT_P_223.194_228.194','RR 10'),
('01GP-SR091-226_1','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-226_0','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-226_1','FT_P_223.194_228.194','RR 10'),
('11GP-SR091-226_0','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-226_0','FT_S_224.07_229.07','RR 10'),
('11GP-SR091-226_5','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-226_5','FT_S_224.07_229.07','RR 10'),
('01GP-SR091-226_5','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-226_5','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-226_5 0','FT_P_223.194_228.194','RR 10'),
('11GP-SR091-226_5','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-226_5','FT_S_224.07_229.07','RR 10'),
('01GP-SR091-226_8','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-226_8','FT_P_223.194_228.194','RR 10'),
('11GP-SR091-226_8','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-226_8','FT_S_224.07_229.07','RR 10'),
('01GP-SR091-227_2','FT_P_223.194_228.194','RR 10'),
('02GP-SR091-227_2','FT_P_223.194_228.194','RR 10'),
('11GP-SR091-227_2','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-227_2','FT_S_224.07_229.07','RR 10'),
('01GP-SR091-228_5','FT_P_228.395_233.395','RR 11'),
('02GP-SR091-228_5','FT_P_228.395_233.395','RR 11'),
('11GP-SR091-228_5','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-228_5','FT_S_224.07_229.07','RR 10'),
('01GP-SR091-229_0','FT_P_228.395_233.395','RR 11'),
('02GP-SR091-229_0','FT_P_228.395_233.395','RR 11'),
('11GP-SR091-229_0','FT_S_224.07_229.07','RR 10'),
('12GP-SR091-229_0','FT_S_224.07_229.07','RR 10'),
('01GP-SR091-229_4','FT_P_228.395_233.395','RR 11'),
('02GP-SR091-229_4','FT_P_228.395_233.395','RR 11'),
('01GP-SR091-229_9','FT_P_228.395_233.395','RR 11'),
('02GP-SR091-229_9','FT_P_228.395_233.395','RR 11'),
('01GP-SR091-230_5','FT_P_228.395_233.395','RR 11'),
('091-230-5NB-LNK-lane1','FT_P_228.395_233.395','RR 11'),
('01GP-SR091-231_0','FT_P_228.395_233.395','RR 11'),
('02GP-SR091-231_0','FT_P_228.395_233.395','RR 11'),
('01GP-SR091-232_0','FT_P_228.395_233.395','RR 11'),
('02GP-SR091-232_0','FT_P_228.395_233.395','RR 11'),
('01GP-SR091-233_0','FT_P_228.395_233.395','RR 11'),
('02GP-SR091-233_0','FT_P_228.395_233.395','RR 11'),
('01GP-SR091-233_5','FT_P_228.395_233.395','RR 11'),
('02GP-SR091-233_5','FT_P_228.395_233.395','RR 11'),
('11GP-SR091-242_5','FT_S_242.271_244.271','RR 11'),
('12GP-SR091-242_5','FT_S_242.271_244.271','RR 11'),
('11GP-SR091-243_0','FT_S_242.271_244.271','RR 11'),
('12GP-SR091-243_0','FT_S_242.271_244.271','RR 11'),
('11GP-SR091-243_5','FT_S_242.271_244.271','RR 11'),
('12GP-SR091-243_5','FT_S_242.271_244.271','RR 11'),
('11GP-SR091-244_0','FT_S_242.271_244.271','RR 11'),
('12GP-SR091-244_0','FT_S_242.271_244.271','RR 11'),
('11GP-SR091-245_4','FT_S_245.271_247.271','RR 12'),
('12GP-SR091-245_4','FT_S_245.271_247.271','RR 12'),
('11GP-SR091-245_8','FT_S_245.271_247.271','RR 12'),
('12GP-SR091-245_8','FT_S_245.271_247.271','RR 12'),
('11GP-SR091-246_1','FT_S_245.271_247.271','RR 12'),
('12GP-SR091-246_1','FT_S_245.271_247.271','RR 12'),
('11GP-SR091-246_5','FT_S_245.271_247.271','RR 12'),
('12GP-SR091-246_5','FT_S_245.271_247.271','RR 12'),
('11GP-SR091-247_0','FT_S_245.271_247.271','RR 12'),
('12GP-SR091-247_0','FT_S_245.271_247.271','RR 12'),
('01GP-SR091-247_5','FT_P_247.415_249.415','RR 12'),
('02GP-SR091-247_5','FT_P_247.415_249.415','RR 12'),
('01GP-SR091-247_9','FT_P_247.415_249.415','RR 12'),
('02GP-SR091-247_9','FT_P_247.415_249.415','RR 12'),
('01GP-SR091-248_4','FT_P_247.415_249.415','RR 12'),
('02GP-SR091-248_4','FT_P_247.415_249.415','RR 12'),
('03AX-SR091-248-4','FT_P_247.415_249.415','RR 12'),
('03AX-SR091-248_4','FT_P_247.415_249.415','RR 12'),
('01GP-SR091-248_7','FT_P_247.415_249.415','RR 12'),
('02GP-SR091-248_7','FT_P_247.415_249.415','RR 12'),
('01GP-SR091-249_2','FT_P_247.415_249.415','RR 12'),
('02GP-SR091-249_2','FT_P_247.415_249.415','RR 12'),
('03GP-SR091-249_2','FT_P_247.415_249.415','RR 12'),
('04GP-SR091-249_2','FT_P_247.415_249.415','RR 12'),
('05AX-SR091-249_2','FT_P_247.415_249.415','RR 12'),
('05GP-SR091-249_2','FT_P_247.415_249.415','RR 12'),
('01GP-SR091-286_6','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-286_6','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-286_6','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-286_6','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-287_0','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-287_0','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-287_0','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-287_0','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-287_3','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-287_3','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-287_3','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-287_3','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-287_6','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-287_6','FT_P_285.721_290.721','RR 14'),
('03GP-SR091-287_6','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-287_6','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-287_6','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-287_8','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-287_8','FT_P_285.721_290.721','RR 14'),
('091287-9SB-LANE9','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-287_8','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-287_8','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-288_4','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-288_4','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-288_4','FT_S_285.721_290.721','RR 14'),
('11GP-SR091-288_5','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-288_4','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-288_5','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-288_8','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-288_8','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-288_8','FT_S_285.721_290.721','RR 14'),
('11GP-SR091-288_9','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-288_8','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-288_9','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-289_1','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-289_1','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-289_1','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-289_1','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-289_5','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-289_5','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-289_5','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-289_5','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-290_3','FT_P_285.721_290.721','RR 14'),
('02GP-SR091-290_3','FT_P_285.721_290.721','RR 14'),
('11GP-SR091-290_3','FT_S_285.721_290.721','RR 14'),
('12GP-SR091-290_3','FT_S_285.721_290.721','RR 14'),
('01GP-SR091-298_0','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-298_0','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-299_2','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-299_2','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-299_8','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-299_8','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-300_2','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-300_2','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-300_3','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-300_4','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-300_3','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-300_4','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-300_8','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-300_8','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-301_3','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-301_4','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-301_3','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-301_4','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-302_3','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-302_4','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-302_3','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-302_4','FT_P_298.005_303.005','RR 14'),
('01GP-SR091-302_8','FT_P_298.005_303.005','RR 14'),
('02GP-SR091-302_8','FT_P_298.005_303.005','RR 14'),
('11GP-SR417-041_3','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-041_3','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-041_3','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-041_3','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-041_6','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-041_6','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-042_6','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-042_6','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-042_9','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-042_9','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-043_3','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-043_3','SE_S_43.0_45.0','RR 3'),
('13AX-SR417-043_3','SE_S_43.0_45.0','RR 3'),
('13GP-SR417-043_3','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-043_7','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-043_7','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-044_1','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-044_1','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-044_5','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-044_5','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-044_5','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-044_5','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-046_5','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-046_5','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-047_0','SE_S_43.0_45.0','RR 3'),
('11GP-SR417-047_0.','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-047_0','SE_S_43.0_45.0','RR 3'),
('12GP-SR417-047_0.','SE_S_43.0_45.0','RR 3'),
('11GP-SR429-000_9','DWB_S_0.896_2.896','RR 1'),
('12GP-SR429-000_9','DWB_S_0.896_2.896','RR 1'),
('11GP-SR429-001_2','DWB_S_0.896_2.896','RR 1'),
('12GP-SR429-001_2','DWB_S_0.896_2.896','RR 1'),
('11GP-SR429-001_6','DWB_S_0.896_2.896','RR 1'),
('12GP-SR429-001_6','DWB_S_0.896_2.896','RR 1'),
('11GP-SR429-001_6','DWB_S_0.896_2.896','RR 1'),
('12GP-SR429-001_6','DWB_S_0.896_2.896','RR 1'),
('11GP-SR429-002_1','DWB_S_0.896_2.896','RR 1'),
('12GP-SR429-002_1','DWB_S_0.896_2.896','RR 1'),
('11GP-SR429-002_5','DWB_S_0.896_2.896','RR 1'),
('12GP-SR429-002_5','DWB_S_0.896_2.896','RR 1'),
('01GP-SR589-024_2','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-024_2','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-024_6','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-024_6','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-025_0','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-025_0','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-025_3','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-025_3','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-025_7','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-025_7','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-026_1','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-026_1','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-026_7','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-026_7','SV_P_24.297_29.297','RR 2'),
('01EL-SR821--026_9','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-026_9','SV_P_24.297_29.297','RR 2'),
('01GP-SR821-026_9','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-026_9','SV_P_24.297_29.297','RR 2'),
('02GP-SR821--026_9','SV_P_24.297_29.297','RR 2'),
('02GP-SR821-026_9','SV_P_24.297_29.297','RR 2'),
('03GP-SR821--026_9','SV_P_24.297_29.297','RR 2'),
('03GP-SR821-026_9','SV_P_24.297_29.297','RR 2'),
('04GP-SR821--026_9','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-027_4','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-027_5','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-027_4','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-027_5','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-027_9','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-028_0','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-027_9','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-028_0','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-028_3','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-028_4','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-028_3','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-028_4','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-028_7','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-028_7','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-029_0','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-029_1','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-029_0','SV_P_24.297_29.297','RR 2'),
('02GP-SR589-029_1','SV_P_24.297_29.297','RR 2'),
('01GP-SR589-043_0','SV_P_43.0_45.0','RR 3'),
('01GP-SR589-043_1','SV_P_43.0_45.0','RR 3'),
('02GP-SR589-043_0','SV_P_43.0_45.0','RR 3'),
('02GP-SR589-043_1','SV_P_43.0_45.0','RR 3'),
('01GP-SR589-043_4','SV_P_43.0_45.0','RR 3'),
('01GP-SR589-043_5','SV_P_43.0_45.0','RR 3'),
('02GP-SR589-043_4','SV_P_43.0_45.0','RR 3'),
('02GP-SR589-043_5','SV_P_43.0_45.0','RR 3'),
('01GP-SR589-044_0','SV_P_43.0_45.0','RR 3'),
('02GP-SR589-044_0','SV_P_43.0_45.0','RR 3'),
('01GP-SR589-044_3','SV_P_43.0_45.0','RR 3'),
('01GP-SR589-044_4','SV_P_43.0_45.0','RR 3'),
('02GP-SR589-044_3','SV_P_43.0_45.0','RR 3'),
('02GP-SR589-044_4','SV_P_43.0_45.0','RR 3'),
('01GP-SR589-044_8','SV_P_43.0_45.0','RR 3'),
('01GP-SR589-044_9','SV_P_43.0_45.0','RR 3'),
('02GP-SR589-044_8','SV_P_43.0_45.0','RR 3'),
('02GP-SR589-044_9','SV_P_43.0_45.0','RR 3'),
('01GP-SR589-049_0','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-049_0','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-049_4','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-049_4','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-049_6','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-049_6','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-049_9','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-049_9','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-050_0','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-050_0','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-050_3','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-050_3','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-050_4','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-050_4','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-050_8','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-050_8','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-051_2','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-051_3','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-051_2','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-051_3','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-051_8','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-051_8','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-053_7','SV_P_48.823_53.823','RR 4'),
('01GP-SR589-053_8','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-053_7','SV_P_48.823_53.823','RR 4'),
('02GP-SR589-053_8','SV_P_48.823_53.823','RR 4'),
('01EL-SR821-038_7','HEF_P_38.607_40.607','RR 3'),
('02GP-SR821-038_7','HEF_P_38.607_40.607','RR 3'),
('03GP-SR821-038_7','HEF_P_38.607_40.607','RR 3'),
('04GP-SR821-038_7','HEF_P_38.607_40.607','RR 3'),
('05AX-SR821-038_7','HEF_P_38.607_40.607','RR 3'),
('01GP-SR821-038_9','HEF_P_38.607_40.607','RR 3'),
('02GP-SR821-038_9','HEF_P_38.607_40.607','RR 3'),
('01GP-SR821-039_2','HEF_P_38.607_40.607','RR 3'),
('01GP-SR821-039_6-A','HEF_P_38.607_40.607','RR 3'),
('02GP-SR821-039_6-A','HEF_P_38.607_40.607','RR 3'),
('03GP-SR821-039_6-A','HEF_P_38.607_40.607','RR 3'),
('04GP-SR821-039_6-A','HEF_P_38.607_40.607','RR 3'),
('01GP-SR821-039_4-N-B','HEF_P_38.607_40.607','RR 3'),
('02GP-SR821-039_4-N-B','HEF_P_38.607_40.607','RR 3'),
('03AX-SR821-039_6-B','HEF_P_38.607_40.607','RR 3'),
('03AX-SR821-039_6-B-AX','HEF_P_38.607_40.607','RR 3'),
('04AX-SR821-039_6-B','HEF_P_38.607_40.607','RR 3'),
('04AX-SR821-039_6-B-AX','HEF_P_38.607_40.607','RR 3'),
('01GP-SR821-039_6-S-C','HEF_P_38.607_40.607','RR 3'),
('02GP-SR821-039_6-S-C','HEF_P_38.607_40.607','RR 3'),
('01GP-SR821-039_9-A','HEF_P_38.607_40.607','RR 3'),
('02GP-SR821-039_9-A','HEF_P_38.607_40.607','RR 3'),
('03GP-SR821-039_9-A','HEF_P_38.607_40.607','RR 3'),
('04AX-SR821-039_9-A','HEF_P_38.607_40.607','RR 3'),
('05AX-SR821-039_9-A','HEF_P_38.607_40.607','RR 3'),
('04AX-SR821-039_9-B','HEF_P_38.607_40.607','RR 3'),
('05AX-SR821-039_9-B','HEF_P_38.607_40.607','RR 3');

------------------------------------------------------------
-- 1) Lane history (ALL detector versions)
------------------------------------------------------------
IF OBJECT_ID('tempdb..#LaneHist') IS NOT NULL DROP TABLE #LaneHist;

;WITH LSM AS (
    SELECT
        LANE_NAME,
        SID,
        SEGMENTS,
        REPLACE(UPPER(LTRIM(RTRIM(LANE_NAME))) COLLATE SQL_Latin1_General_CP1_CI_AS, '.', '') AS lane_key
    FROM @LaneSegmentMap
),
TL AS (
    SELECT
        TL.ID AS ARCHIVE_LANE_ID,
        TL.ARCHIVE_DETECTOR_ID,
        TL.ARCHIVE_LINK_ID,
        TL.DATE_CREATED,
        REPLACE(UPPER(LTRIM(RTRIM(TL.LANE_NAME))) COLLATE SQL_Latin1_General_CP1_CI_AS, '.', '') AS lane_key
    FROM ODS_TSS_LANES TL WITH (NOLOCK)
    WHERE TL.ARCHIVE_DETECTOR_ID IS NOT NULL
)
SELECT DISTINCT
    LSM.LANE_NAME,
    LSM.SID,
    LSM.SEGMENTS,
    TL.ARCHIVE_DETECTOR_ID,
    TL.DATE_CREATED
INTO #LaneHist
FROM LSM
JOIN TL
  ON TL.lane_key = LSM.lane_key;

CREATE INDEX IX_LaneHist_Det ON #LaneHist(ARCHIVE_DETECTOR_ID);

------------------------------------------------------------
-- 2) Detector lat-long
------------------------------------------------------------
IF OBJECT_ID('tempdb..#DetCfg') IS NOT NULL DROP TABLE #DetCfg;

SELECT
    TDC.ID AS ARCHIVE_DETECTOR_ID,

    CASE
      WHEN TRY_CAST(TDC.EQUIP_LOC_LAT AS float) IS NULL THEN NULL
      WHEN ABS(TRY_CAST(TDC.EQUIP_LOC_LAT AS float)) > 900000 THEN TRY_CAST(TDC.EQUIP_LOC_LAT AS float)/1000000.0
      WHEN ABS(TRY_CAST(TDC.EQUIP_LOC_LAT AS float)) > 9000   THEN TRY_CAST(TDC.EQUIP_LOC_LAT AS float)/100.0
      WHEN ABS(TRY_CAST(TDC.EQUIP_LOC_LAT AS float)) > 900    THEN TRY_CAST(TDC.EQUIP_LOC_LAT AS float)/10.0
      ELSE TRY_CAST(TDC.EQUIP_LOC_LAT AS float)
    END AS Detector_LATITUDE,

    CASE
      WHEN TRY_CAST(TDC.EQUIP_LOC_LONG AS float) IS NULL THEN NULL
      WHEN ABS(TRY_CAST(TDC.EQUIP_LOC_LONG AS float)) > 1800000 THEN TRY_CAST(TDC.EQUIP_LOC_LONG AS float)/1000000.0
      WHEN ABS(TRY_CAST(TDC.EQUIP_LOC_LONG AS float)) > 18000   THEN TRY_CAST(TDC.EQUIP_LOC_LONG AS float)/100.0
      WHEN ABS(TRY_CAST(TDC.EQUIP_LOC_LONG AS float)) > 1800    THEN TRY_CAST(TDC.EQUIP_LOC_LONG AS float)/10.0
      ELSE TRY_CAST(TDC.EQUIP_LOC_LONG AS float)
    END AS Detector_LONGITUDE
INTO #DetCfg
FROM ODS_TSS_DETECTOR_CONFIGS TDC WITH (NOLOCK);

CREATE INDEX IX_DetCfg_ID ON #DetCfg(ARCHIVE_DETECTOR_ID);

------------------------------------------------------------
-- 3) FINAL TIME-SERIES OUTPUT (USES @StartDate / @EndDate from API)
------------------------------------------------------------
;WITH X AS (
  SELECT
      TRD.ROLLUP_TIMESTAMP,
      TRD.TOTAL_VOLUME,
      TRD.AVERAGE_SPEED,
      LH.LANE_NAME,
      LH.SID,
      LH.SEGMENTS,
      DC.Detector_LATITUDE,
      DC.Detector_LONGITUDE,

      ROW_NUMBER() OVER (
        PARTITION BY LH.LANE_NAME, TRD.ROLLUP_TIMESTAMP
        ORDER BY LH.DATE_CREATED DESC
      ) AS rn
  FROM #LaneHist LH
  JOIN ODS_TSS_ROLLUP_DATA TRD WITH (NOLOCK)
    ON TRD.ARCHIVE_DETECTOR_ID = LH.ARCHIVE_DETECTOR_ID
  LEFT JOIN #DetCfg DC
    ON DC.ARCHIVE_DETECTOR_ID = LH.ARCHIVE_DETECTOR_ID
  WHERE
      TRD.ROLLUP_INTERVAL = '15MIN'
      AND TRD.ROLLUP_TIMESTAMP >= @StartDate
      AND TRD.ROLLUP_TIMESTAMP <  @EndDate
)
SELECT
    ROLLUP_TIMESTAMP,
    TOTAL_VOLUME,
    AVERAGE_SPEED,
    LANE_NAME,
    SID,
    SEGMENTS,
    Detector_LATITUDE,
    Detector_LONGITUDE
FROM X
WHERE rn = 1
ORDER BY LANE_NAME, ROLLUP_TIMESTAMP;
`;
}

module.exports = { buildRollupQuerySql };
